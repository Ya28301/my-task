<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مهامي | قائمة المهام الذكية</title>
  
  <!-- الخطوط -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  
  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  
  <style>
    :root {
      --primary: #6C5CE7;
      --primary-dark: #5649D1;
      --secondary: #00B894;
      --danger: #D63031;
      --warning: #FDCB6E;
      --light: #F8F9FA;
      --dark: #2D3436;
      --gray: #636E72;
      --light-gray: #DFE6E9;
      
      /* ألوان الثيم النهاري الجديد */
      --day-bg: #f0f8ff;
      --day-card: #ffffff;
      --day-text: #2D3436;
      --day-border: #d1e0ff;
      
      /* القيم الافتراضية */
      --bg: var(--day-bg);
      --card-bg: var(--day-card);
      --text: var(--day-text);
      --text-light: #F8F9FA;
      --border: var(--day-border);
      --shadow: rgba(0, 0, 0, 0.1);
    }
    
    .dark-mode {
      --primary: #A29BFE;
      --primary-dark: #847BFF;
      --bg: #1E272E;
      --card-bg: #2D3436;
      --text: #F8F9FA;
      --border: #636E72;
      --shadow: rgba(0, 0, 0, 0.3);
    }
    
    body {
      background: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
      min-height: 100vh;
      font-family: 'Tajawal', sans-serif;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      position: relative;
    }
    
    .header p {
      opacity: 0.9;
      font-size: 14px;
      position: relative;
    }
    
    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 3px 10px var(--shadow);
      text-align: center;
      transition: transform 0.3s ease;
      border: 1px solid var(--border);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card i {
      font-size: 24px;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .stat-card h3 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      font-size: 12px;
      color: var(--gray);
    }
    
    /* Progress */
    .progress-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 3px 10px var(--shadow);
      border: 1px solid var(--border);
    }
    
    .progress-title {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .progress-bar {
      height: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    
    /* Search Task */
    .search-task {
      display: flex;
      margin-bottom: 15px;
    }
    
    .search-task input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      background: var(--card-bg);
      color: var(--text);
    }
    
    .search-task button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
      margin-right: 10px;
    }
    
    .search-task button:hover {
      background: var(--primary-dark);
    }
    
    /* Add Task */
    .add-task {
      display: flex;
      margin-bottom: 25px;
    }
    
    .add-task input {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px 0 0 8px;
      font-size: 16px;
      background: var(--card-bg);
      color: var(--text);
    }
    
    .add-task button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 20px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s ease;
    }
    
    .add-task button:hover {
      background: var(--primary-dark);
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .filters::-webkit-scrollbar {
      height: 5px;
    }
    
    .filters::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 5px;
    }
    
    .filter-btn {
      padding: 8px 15px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s ease;
    }
    
    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Tasks List */
    .tasks-list {
      margin-bottom: 30px;
    }
    
    .task {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 3px 10px var(--shadow);
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary);
      border: 1px solid var(--border);
    }
    
    .task:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px var(--shadow);
    }
    
    .task.completed {
      border-left-color: var(--secondary);
      opacity: 0.8;
    }
    
    .task.completed .task-title {
      text-decoration: line-through;
      color: var(--gray);
    }
    
    .task-checkbox {
      margin-left: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--secondary);
    }
    
    .task-content {
      flex: 1;
    }
    
    .task-title {
      font-size: 16px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .task-date {
      font-size: 12px;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .task-category {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-right: 5px;
      background: var(--light-gray);
      color: var(--dark);
    }
    
    .task-category.work {
      background: #ffeaa7;
      color: #d63031;
    }
    
    .task-category.personal {
      background: #a5f3fc;
      color: #0e7490;
    }
    
    .task-category.study {
      background: #c4f0c4;
      color: #166534;
    }
    
    .task-actions {
      display: flex;
      gap: 10px;
      margin-right: 10px;
    }
    
    .task-btn {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: transparent;
      border: none;
      color: var(--gray);
    }
    
    .task-btn:hover {
      transform: scale(1.1);
    }
    
    .task-btn.edit:hover {
      color: var(--primary);
      background: rgba(108, 92, 231, 0.1);
    }
    
    .task-btn.delete:hover {
      color: var(--danger);
      background: rgba(214, 48, 49, 0.1);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px dashed var(--border);
    }
    
    .empty-state i {
      font-size: 50px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    /* Theme Toggle */
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      border: none;
      z-index: 100;
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
    }
    
    /* Import/Export Buttons */
    .data-actions {
      position: fixed;
      bottom: 80px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    
    .data-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      border: none;
      transition: all 0.3s ease;
    }
    
    .data-btn:hover {
      transform: scale(1.1);
    }
    
    .data-btn i {
      font-size: 20px;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      font-size: 20px;
    }
    
    .modal-header .close-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      background: var(--card-bg);
      color: var(--text);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--light-gray);
      color: var(--dark);
    }
    
    .btn-secondary:hover {
      background: var(--gray);
      color: white;
    }
    
    /* Animations */
    .animate__animated {
      animation-duration: 0.5s;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .header {
        padding: 15px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .task {
        padding: 12px;
      }
      
      .task-title {
        font-size: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .add-task input,
      .search-task input {
        padding: 10px 12px;
      }
      
      .task-actions {
        flex-direction: column;
        gap: 5px;
      }
      
      .task-btn {
        width: 30px;
        height: 30px;
      }
      
      .data-actions {
        bottom: 140px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header animate__animated animate__fadeInDown">
      <h1>قائمة المهام الذكية</h1>
      <p>نظم يومك وزد إنتاجيتك</p>
    </header>
    
    <div class="stats-container animate__animated animate__fadeIn animate__delay-1s">
      <div class="stat-card">
        <i class="fas fa-tasks"></i>
        <h3 id="total-tasks">0</h3>
        <p>المهام الكلية</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-check-circle"></i>
        <h3 id="completed-tasks">0</h3>
        <p>مكتملة</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-clock"></i>
        <h3 id="pending-tasks">0</h3>
        <p>قيد الانتظار</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-calendar-day"></i>
        <h3 id="today-tasks">0</h3>
        <p>مهام اليوم</p>
      </div>
    </div>
    
    <div class="progress-container animate__animated animate__fadeIn animate__delay-1s">
      <div class="progress-title">
        <span>تقدمك اليوم</span>
        <span id="progress-percent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="search-task animate__animated animate__fadeIn animate__delay-1s">
      <input type="text" id="search-input" placeholder="ابحث في المهام...">
      <button id="search-btn"><i class="fas fa-search"></i></button>
    </div>
    
    <div class="add-task animate__animated animate__fadeIn animate__delay-1s">
      <input type="text" id="new-task-input" placeholder="أضف مهمة جديدة...">
      <button id="add-task-btn"><i class="fas fa-plus"></i></button>
    </div>
    
    <div class="filters animate__animated animate__fadeIn animate__delay-1s">
      <button class="filter-btn active" data-filter="all">الكل</button>
      <button class="filter-btn" data-filter="today">اليوم</button>
      <button class="filter-btn" data-filter="week">هذا الأسبوع</button>
      <button class="filter-btn" data-filter="completed">المكتملة</button>
      <button class="filter-btn" data-filter="pending">غير المكتملة</button>
      <button class="filter-btn" data-filter="work">عمل</button>
      <button class="filter-btn" data-filter="personal">شخصي</button>
      <button class="filter-btn" data-filter="study">دراسة</button>
    </div>
    
    <div class="tasks-list" id="tasks-list">
      <div class="empty-state">
        <i class="fas fa-tasks"></i>
        <h3>لا توجد مهام لعرضها</h3>
        <p>ابدأ بإضافة مهام جديدة</p>
      </div>
    </div>
  </div>
  
  <div class="data-actions">
    <button class="data-btn" id="export-btn" title="تصدير المهام">
      <i class="fas fa-file-export"></i>
    </button>
    <button class="data-btn" id="import-btn" title="استيراد المهام">
      <i class="fas fa-file-import"></i>
    </button>
    <input type="file" id="import-file" accept=".json" style="display: none;">
  </div>
  
  <button class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
  </button>
  
  <div class="modal" id="task-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">إضافة مهمة جديدة</h2>
        <button class="close-btn" id="close-modal">&times;</button>
      </div>
      <form id="task-form">
        <input type="hidden" id="task-id">
        <div class="form-group">
          <label for="task-title">عنوان المهمة</label>
          <input type="text" id="task-title" required>
        </div>
        <div class="form-group">
          <label for="task-description">الوصف (اختياري)</label>
          <textarea id="task-description"></textarea>
        </div>
        <div class="form-group">
          <label for="task-date">تاريخ الاستحقاق</label>
          <input type="date" id="task-date" required>
        </div>
        <div class="form-group">
          <label for="task-priority">الأولوية</label>
          <select id="task-priority">
            <option value="low">منخفضة</option>
            <option value="medium">متوسطة</option>
            <option value="high">عالية</option>
          </select>
        </div>
        <div class="form-group">
          <label for="task-category">التصنيف</label>
          <select id="task-category">
            <option value="work">عمل</option>
            <option value="personal">شخصي</option>
            <option value="study">دراسة</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancel-task">إلغاء</button>
          <button type="submit" class="btn btn-primary" id="save-task">حفظ</button>
        </div>
      </form>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const newTaskInput = document.getElementById('new-task-input');
      const addTaskBtn = document.getElementById('add-task-btn');
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('search-btn');
      const tasksList = document.getElementById('tasks-list');
      const themeToggle = document.getElementById('theme-toggle');
      const taskModal = document.getElementById('task-modal');
      const closeModal = document.getElementById('close-modal');
      const cancelTask = document.getElementById('cancel-task');
      const taskForm = document.getElementById('task-form');
      const modalTitle = document.getElementById('modal-title');
      const taskIdInput = document.getElementById('task-id');
      const taskTitleInput = document.getElementById('task-title');
      const taskDescriptionInput = document.getElementById('task-description');
      const taskDateInput = document.getElementById('task-date');
      const taskPriorityInput = document.getElementById('task-priority');
      const taskCategoryInput = document.getElementById('task-category');
      const filterButtons = document.querySelectorAll('.filter-btn');
      const exportBtn = document.getElementById('export-btn');
      const importBtn = document.getElementById('import-btn');
      const importFile = document.getElementById('import-file');
      
      // Stats Elements
      const totalTasksEl = document.getElementById('total-tasks');
      const completedTasksEl = document.getElementById('completed-tasks');
      const pendingTasksEl = document.getElementById('pending-tasks');
      const todayTasksEl = document.getElementById('today-tasks');
      const progressPercentEl = document.getElementById('progress-percent');
      const progressFillEl = document.getElementById('progress-fill');
      
      // State
      let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
      let currentFilter = 'all';
      let currentSearch = '';
      let editingTaskId = null;
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      taskDateInput.value = today;
      
      // Initialize
      renderTasks();
      updateStats();
      
      // Event Listeners
      addTaskBtn.addEventListener('click', function(e) {
        e.preventDefault();
        addTask();
      });
      
      newTaskInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addTask();
        }
      });
      
      searchBtn.addEventListener('click', function(e) {
        e.preventDefault();
        searchTasks();
      });
      
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchTasks();
        }
      });
      
      themeToggle.addEventListener('click', function(e) {
        e.preventDefault();
        toggleTheme();
      });
      
      closeModal.addEventListener('click', function(e) {
        e.preventDefault();
        closeTaskModal();
      });
      
      cancelTask.addEventListener('click', function(e) {
        e.preventDefault();
        closeTaskModal();
      });
      
      taskForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveTask();
      });
      
      filterButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTasks();
        });
      });
      
      exportBtn.addEventListener('click', function(e) {
        e.preventDefault();
        exportTasks();
      });
      
      importBtn.addEventListener('click', function(e) {
        e.preventDefault();
        importFile.click();
      });
      
      importFile.addEventListener('change', function(e) {
        importTasks(e);
      });
      
      // Functions
      function addTask() {
        const title = newTaskInput.value.trim();
        if (title) {
          editingTaskId = null;
          modalTitle.textContent = 'إضافة مهمة جديدة';
          taskTitleInput.value = title;
          taskDescriptionInput.value = '';
          taskDateInput.value = today;
          taskPriorityInput.value = 'medium';
          taskCategoryInput.value = 'work';
          openTaskModal();
          newTaskInput.value = '';
        } else {
          showToast('الرجاء إدخال عنوان للمهمة', 'error');
        }
      }
      
      function searchTasks() {
        currentSearch = searchInput.value.trim().toLowerCase();
        renderTasks();
      }
      
      function openTaskModal() {
        taskModal.classList.add('active');
      }
      
      function closeTaskModal() {
        taskModal.classList.remove('active');
      }
      
      function saveTask() {
        const title = taskTitleInput.value.trim();
        const description = taskDescriptionInput.value.trim();
        const date = taskDateInput.value;
        const priority = taskPriorityInput.value;
        const category = taskCategoryInput.value;
        
        if (!title) {
          showToast('الرجاء إدخال عنوان للمهمة', 'error');
          return;
        }
        
        if (!date) {
          showToast('الرجاء تحديد تاريخ الاستحقاق', 'error');
          return;
        }
        
        const task = {
          id: editingTaskId || Date.now().toString(),
          title,
          description,
          date,
          priority,
          category,
          completed: false,
          createdAt: new Date().toISOString()
        };
        
        if (editingTaskId) {
          // Update existing task
          const index = tasks.findIndex(t => t.id === editingTaskId);
          if (index !== -1) {
            tasks[index] = task;
            showToast('تم تحديث المهمة بنجاح', 'success');
          }
        } else {
          // Add new task
          tasks.unshift(task);
          showToast('تم إضافة المهمة بنجاح', 'success');
        }
        
        saveTasks();
        closeTaskModal();
      }
      
      function editTask(id) {
        const task = tasks.find(t => t.id === id);
        if (task) {
          editingTaskId = id;
          modalTitle.textContent = 'تعديل المهمة';
          taskIdInput.value = task.id;
          taskTitleInput.value = task.title;
          taskDescriptionInput.value = task.description || '';
          taskDateInput.value = task.date;
          taskPriorityInput.value = task.priority || 'medium';
          taskCategoryInput.value = task.category || 'work';
          openTaskModal();
        }
      }
      
      function deleteTask(id) {
        if (confirm('هل أنت متأكد من حذف هذه المهمة؟')) {
          tasks = tasks.filter(task => task.id !== id);
          saveTasks();
          showToast('تم حذف المهمة بنجاح', 'success');
        }
      }
      
      function toggleTaskCompletion(id) {
        const task = tasks.find(t => t.id === id);
        if (task) {
          task.completed = !task.completed;
          saveTasks();
          showToast(`تم ${task.completed ? 'إكمال' : 'إلغاء إكمال'} المهمة`, 'success');
        }
      }
      
      function saveTasks() {
        localStorage.setItem('tasks', JSON.stringify(tasks));
        renderTasks();
        updateStats();
      }
      
      function renderTasks() {
        let filteredTasks = [...tasks];
        const today = new Date().toISOString().split('T')[0];
        
        // Apply search filter
        if (currentSearch) {
          filteredTasks = filteredTasks.filter(task => {
            const title = (task.title || '').toLowerCase();
            const desc = (task.description || '').toLowerCase();
            return title.includes(currentSearch) || desc.includes(currentSearch);
          });
        }
        
        // Apply category filter
        switch (currentFilter) {
          case 'today':
            filteredTasks = filteredTasks.filter(task => task.date === today);
            break;
          case 'week':
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];
            filteredTasks = filteredTasks.filter(task => task.date >= today && task.date <= nextWeekStr);
            break;
          case 'completed':
            filteredTasks = filteredTasks.filter(task => task.completed);
            break;
          case 'pending':
            filteredTasks = filteredTasks.filter(task => !task.completed);
            break;
          case 'work':
          case 'personal':
          case 'study':
            filteredTasks = filteredTasks.filter(task => task.category === currentFilter);
            break;
        }
        
        if (filteredTasks.length === 0) {
          tasksList.innerHTML = `
            <div class="empty-state animate__animated animate__fadeIn">
              <i class="fas fa-tasks"></i>
              <h3>لا توجد مهام لعرضها</h3>
              <p>${currentFilter === 'all' && !currentSearch ? 'ابدأ بإضافة مهام جديدة' : 'لا توجد مهام تطابق الفلتر المحدد'}</p>
            </div>
          `;
          return;
        }
        
        // Sort tasks by date (ascending) and completion status (pending first)
        filteredTasks.sort((a, b) => {
          if (a.completed !== b.completed) {
            return a.completed ? 1 : -1;
          }
          return new Date(a.date) - new Date(b.date);
        });
        
        tasksList.innerHTML = filteredTasks.map(task => `
          <div class="task ${task.completed ? 'completed' : ''} animate__animated animate__fadeIn" data-id="${task.id}">
            <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
            <div class="task-content">
              <h3 class="task-title">${escapeHtml(task.title)}</h3>
              <p class="task-date">
                <i class="fas fa-calendar-day"></i>
                ${formatDate(task.date)} ${task.date === today ? '(اليوم)' : ''}
                ${task.priority === 'high' ? '<span style="color: var(--danger); margin-right: 5px;"><i class="fas fa-exclamation-circle"></i> عالية</span>' : ''}
                ${task.priority === 'medium' ? '<span style="color: var(--warning); margin-right: 5px;"><i class="fas fa-info-circle"></i> متوسطة</span>' : ''}
                <span class="task-category ${task.category}">${getCategoryName(task.category)}</span>
              </p>
              ${task.description ? `<p class="task-description" style="margin-top: 5px; font-size: 14px; color: var(--gray);">${escapeHtml(task.description)}</p>` : ''}
            </div>
            <div class="task-actions">
              <button class="task-btn edit" title="تعديل">
                <i class="fas fa-edit"></i>
              </button>
              <button class="task-btn delete" title="حذف">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');
        
        // Add event listeners to dynamically created elements
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const taskId = this.closest('.task').dataset.id;
            toggleTaskCompletion(taskId);
          });
        });
        
        document.querySelectorAll('.task-btn.edit').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const taskId = this.closest('.task').dataset.id;
            editTask(taskId);
          });
        });
        
        document.querySelectorAll('.task-btn.delete').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const taskId = this.closest('.task').dataset.id;
            deleteTask(taskId);
          });
        });
        
        document.querySelectorAll('.task').forEach(taskEl => {
          taskEl.addEventListener('click', function(e) {
            if (!e.target.closest('.task-checkbox') && !e.target.closest('.task-btn')) {
              const taskId = this.dataset.id;
              editTask(taskId);
            }
          });
        });
      }
      
      function updateStats() {
        const totalTasks = tasks.length;
        const completedTasks = tasks.filter(task => task.completed).length;
        const pendingTasks = totalTasks - completedTasks;
        const todayTasks = tasks.filter(task => task.date === new Date().toISOString().split('T')[0]).length;
        
        totalTasksEl.textContent = totalTasks;
        completedTasksEl.textContent = completedTasks;
        pendingTasksEl.textContent = pendingTasks;
        todayTasksEl.textContent = todayTasks;
        
        // Update progress
        const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        progressPercentEl.textContent = `${progress}%`;
        progressFillEl.style.width = `${progress}%`;
      }
      
      function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('darkMode', isDark);
      }
      
      function exportTasks() {
        if (tasks.length === 0) {
          showToast('لا توجد مهام لتصديرها', 'warning');
          return;
        }
        
        const dataStr = JSON.stringify(tasks, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        
        const exportName = `tasks_${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportName);
        linkElement.click();
        
        showToast('تم تصدير المهام بنجاح', 'success');
      }
      
      function importTasks(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const importedTasks = JSON.parse(e.target.result);
            if (Array.isArray(importedTasks) && importedTasks.length > 0) {
              if (confirm(`هل تريد استيراد ${importedTasks.length} مهمة؟ سيتم استبدال المهام الحالية.`)) {
                tasks = importedTasks;
                saveTasks();
                showToast('تم استيراد المهام بنجاح', 'success');
              }
            } else {
              showToast('ملف غير صالح أو لا يحتوي على مهام', 'error');
            }
          } catch (error) {
            showToast('خطأ في قراءة الملف', 'error');
            console.error(error);
          }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
      }
      
      function showToast(message, type) {
        let backgroundColor = '';
        switch (type) {
          case 'success':
            backgroundColor = 'linear-gradient(to right, #00b09b, #96c93d)';
            break;
          case 'error':
            backgroundColor = 'linear-gradient(to right, #ff416c, #ff4b2b)';
            break;
          case 'warning':
            backgroundColor = 'linear-gradient(to right, #f7971e, #ffd200)';
            break;
          default:
            backgroundColor = 'linear-gradient(to right, #4b6cb7, #182848)';
        }
        
        Toastify({
          text: message,
          duration: 3000,
          newWindow: true,
          close: true,
          gravity: "top",
          position: "left",
          stopOnFocus: true,
          style: {
            background: backgroundColor,
            fontFamily: "'Tajawal', sans-serif",
            borderRadius: "8px",
            boxShadow: "0 4px 10px rgba(0, 0, 0, 0.2)"
          },
        }).showToast();
      }
      
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ar-EG', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
      
      function getCategoryName(category) {
        switch (category) {
          case 'work': return 'عمل';
          case 'personal': return 'شخصي';
          case 'study': return 'دراسة';
          default: return category;
        }
      }
      
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      
      // Check for saved theme preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
      }
    });
  </script>
</body>
</html>